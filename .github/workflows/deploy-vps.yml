name: Build and Deploy CMS to VPS (Docker)

on:
  push:
    branches: ['dev', 'main']
    paths:
      - '**'
  workflow_dispatch:

permissions:
  contents: read
  packages: write

env:
  IMAGE_NAME: reactor-cms
  REGISTRY: ghcr.io

jobs:
  ci:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Typecheck
        run: |
          if [ -f tsconfig.json ]; then
            npx tsc --noEmit
          else
            echo "No tsconfig.json found; skipping typecheck"
          fi

      - name: Build (Strapi)
        run: npm run build

  ssh-check:
    runs-on: ubuntu-latest
    steps:
      - name: Add SSH key
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.VPS_SSH_KEY }}

      - name: Add VPS to known_hosts
        run: |
          mkdir -p ~/.ssh
          HOST="${{ secrets.VPS_HOST }}"
          PORT="${{ secrets.VPS_SSH_PORT }}"
          if [ -n "$PORT" ]; then
            ssh-keyscan -p "$PORT" -H "$HOST" >> ~/.ssh/known_hosts
          else
            ssh-keyscan -H "$HOST" >> ~/.ssh/known_hosts
          fi

      - name: Test SSH connectivity
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_USER: ${{ secrets.VPS_USER }}
          VPS_SSH_PORT: ${{ secrets.VPS_SSH_PORT }}
        run: |
          REMOTE="${VPS_USER}@${VPS_HOST}"
          PORT="${VPS_SSH_PORT:-22}"
          ssh -p "$PORT" -o StrictHostKeyChecking=no -o BatchMode=yes "$REMOTE" "echo ok"

  build-and-push:
    runs-on: ubuntu-latest
    needs: ci
    outputs:
      image_latest: ${{ steps.meta.outputs.image_latest }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Prepare image tags (lowercase owner)
        id: meta
        run: |
          OWNER_LC="${OWNER,,}"
          echo "owner=${OWNER_LC}" >> $GITHUB_OUTPUT
          echo "image_latest=ghcr.io/${OWNER_LC}/${IMAGE_NAME}:latest" >> $GITHUB_OUTPUT
          echo "image_sha=ghcr.io/${OWNER_LC}/${IMAGE_NAME}:${GITHUB_SHA}" >> $GITHUB_OUTPUT
        env:
          OWNER: ${{ github.repository_owner }}
          IMAGE_NAME: ${{ env.IMAGE_NAME }}
          GITHUB_SHA: ${{ github.sha }}

      - name: Build and push image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: |
            ${{ steps.meta.outputs.image_latest }}
            ${{ steps.meta.outputs.image_sha }}
          cache-from: type=registry,ref=${{ steps.meta.outputs.image_latest }}
          cache-to: type=inline

      - name: Make GHCR package public (best-effort)
        env:
          OWNER: ${{ github.repository_owner }}
          IMAGE_NAME: ${{ env.IMAGE_NAME }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Attempting to set GHCR package visibility to public"
          STATUS=$(curl -sS -o /dev/null -w "%{http_code}" -X PUT \
            -H "Authorization: Bearer $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "https://api.github.com/user/packages/container/${IMAGE_NAME}/visibility" \
            -d '{"visibility":"public"}')
          echo "User endpoint returned: $STATUS"
          if [ "$STATUS" != "200" ] && [ "$STATUS" != "204" ]; then
            echo "Trying org endpoint..."
            curl -sS -o /dev/null -w "%{http_code}" -X PUT \
              -H "Authorization: Bearer $GITHUB_TOKEN" \
              -H "Accept: application/vnd.github+json" \
              -H "X-GitHub-Api-Version: 2022-11-28" \
              "https://api.github.com/orgs/${OWNER}/packages/container/${IMAGE_NAME}/visibility" \
              -d '{"visibility":"public"}'
          fi
          echo "Visibility step finished (best-effort)."

  deploy:
    needs: [build-and-push, ssh-check]
    runs-on: ubuntu-latest
    if: github.ref_name == 'dev' || github.ref_name == 'main'
    steps:
      - name: Add SSH key
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.VPS_SSH_KEY }}

      - name: Add VPS to known_hosts
        run: |
          mkdir -p ~/.ssh
          HOST="${{ secrets.VPS_HOST }}"
          PORT="${{ secrets.VPS_SSH_PORT }}"
          if [ -n "$PORT" ]; then
            ssh-keyscan -p "$PORT" -H "$HOST" >> ~/.ssh/known_hosts
          else
            ssh-keyscan -H "$HOST" >> ~/.ssh/known_hosts
          fi

      - name: Deploy on VPS via SSH
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_USER: ${{ secrets.VPS_USER }}
          VPS_SSH_PORT: ${{ secrets.VPS_SSH_PORT }}
          VPS_APP_DIR: ${{ secrets.VPS_APP_DIR }}
          VPS_ENV: ${{ secrets.VPS_ENV }}
          GHCR_USERNAME: ${{ secrets.GHCR_USERNAME }}
          GHCR_TOKEN: ${{ secrets.GHCR_TOKEN }}
          IMAGE_LATEST: ${{ needs.build-and-push.outputs.image_latest }}
        run: |
          set -e
          REMOTE="${VPS_USER}@${VPS_HOST}"
          PORT="${VPS_SSH_PORT:-22}"

          echo "=== Creating app directory ==="
          ssh -p "$PORT" -o StrictHostKeyChecking=no "$REMOTE" "mkdir -p ${VPS_APP_DIR}"

          echo "=== Uploading .env ==="
          printf '%s' "${VPS_ENV}" | base64 -w0 > env.b64
          scp -P "$PORT" env.b64 "$REMOTE:${VPS_APP_DIR}/env.b64"
          rm -f env.b64
          ssh -p "$PORT" -o StrictHostKeyChecking=no "$REMOTE" "cd ${VPS_APP_DIR} && base64 -d env.b64 > .env && rm -f env.b64 && sed -i 's/\r$//' .env"

          echo "=== Creating docker-compose.yml ==="
          cat > docker-compose.yml <<EOFCOMPOSE
          services:
            cms:
              image: "${IMAGE_LATEST}"
              container_name: strapi-cms
              env_file: .env
              environment:
                # Only override values that MUST differ from .env
                - DATABASE_HOST=postgres
              depends_on:
                postgres:
                  condition: service_healthy
              ports:
                - "1337:1337"
              volumes:
                - ./public/uploads:/app/public/uploads
              restart: unless-stopped
              networks:
                - cms-network

            postgres:
              image: postgres:16-alpine
              container_name: strapi-db
              environment:
                - POSTGRES_DB=\${DATABASE_NAME}
                - POSTGRES_USER=\${DATABASE_USERNAME}
                - POSTGRES_PASSWORD=\${DATABASE_PASSWORD}
              volumes:
                - ./pgdata:/var/lib/postgresql/data
              healthcheck:
                test: ["CMD-SHELL", "pg_isready -U \$\$POSTGRES_USER -d \$\$POSTGRES_DB"]
                interval: 10s
                timeout: 5s
                retries: 10
              restart: unless-stopped
              networks:
                - cms-network

          networks:
            cms-network:
              driver: bridge
          EOFCOMPOSE
          sed -i 's/^          //' docker-compose.yml
          scp -P "$PORT" docker-compose.yml "$REMOTE:${VPS_APP_DIR}/docker-compose.yml"
          rm -f docker-compose.yml

          echo "=== Checking Docker ==="
          ssh -p "$PORT" -o StrictHostKeyChecking=no "$REMOTE" "docker --version && docker compose version"

          echo "=== GHCR login (if credentials provided) ==="
          if [ -n "${GHCR_USERNAME:-}" ] && [ -n "${GHCR_TOKEN:-}" ]; then
            ssh -p "$PORT" -o StrictHostKeyChecking=no "$REMOTE" "echo '${GHCR_TOKEN}' | docker login ghcr.io -u '${GHCR_USERNAME}' --password-stdin"
          else
            echo "Skipping GHCR login: GHCR_USERNAME or GHCR_TOKEN not set"
          fi

          echo "=== Creating required directories ==="
          ssh -p "$PORT" -o StrictHostKeyChecking=no "$REMOTE" "cd ${VPS_APP_DIR} && mkdir -p public/uploads && chmod 755 public/uploads"

          echo "=== Pulling and starting containers ==="
          ssh -p "$PORT" -o StrictHostKeyChecking=no "$REMOTE" "cd ${VPS_APP_DIR} && docker compose pull && docker compose up -d --remove-orphans && docker image prune -f"

          echo "=== Deploy complete ==="
